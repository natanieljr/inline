


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html id="htmlId">
<head>
  <title>Coverage Report :: PartialGuiModel</title>
  <style type="text/css">
    @import "../../.css/coverage.css";
  </style>
</head>

<body>
<div class="header"></div>

<div class="content">
<div class="breadCrumbs">
    [ <a href="../../index.html">all classes</a> ]
    [ <a href="../index.html">org.droidmate.exploration.abstractgui</a> ]
</div>

<h1>Coverage Summary for Class: PartialGuiModel (org.droidmate.exploration.abstractgui)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">PartialGuiModel</td>
<td class="coverageStat">
  <span class="percent">
    93.5%
  </span>
  <span class="absValue">
    (29/ 31)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    90.6%
  </span>
  <span class="absValue">
    (145/ 160)
  </span>
</td>
</tr>
  <tr>
    <td class="name">PartialGuiModel$_assertConsistent_closure25</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_getGuiStatesByTransitionHistoryMostRecentFirst_closure28</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_getKnownGuiStates_closure1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_getPathGuiStates_closure24</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_getPathTo_closure2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_getPathTo_closure3</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_getPathTo_closure4</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_getTransitionHistorySuffixFromLastOccurrenceOfSrcGuiState_closure6</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_getTransitionHistorySuffixFromLastOccurrenceOfSrcGuiState_closure7</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_getTransitionHistorySuffixFromLastOccurrenceOfSrcGuiState_closure8</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_getTransitionHistorySuffixFromLastOccurrenceOfSrcGuiState_closure9</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_isDeterministic_closure5</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_replaceEdgesIncidentToAppHasStoppedGuiState_closure10</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_replaceEdgesIncidentToAppHasStoppedGuiState_closure11</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_replaceEdgesIncidentToAppHasStoppedGuiState_closure12</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_replaceEdgesIncidentToAppHasStoppedGuiState_closure13</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_replaceEdgesIncidentToAppHasStoppedGuiState_closure14</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_replaceEdgesIncidentToAppHasStoppedGuiState_closure15</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_reverseEdge_closure16</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_shortenPath_closure17</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_shortenPath_closure18</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_shortenPath_closure19</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_shortenPath_closure20</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_shortenPath_closure21</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_shortenPath_closure22</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_shortenPath_closure23</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_toString_closure29</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_transit_closure26</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$_transit_closure27</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$assertConsistent$0</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$createEmptyPartialGuiModel</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$createPartialGuiModelWithInitState$5</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$getPathGuiStates$3</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$getTransitionHistorySuffixFromLastOccurrenceOfSrcGuiState$1</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$replaceEdgesIncidentToAppHasStoppedGuiState$2</td>
  </tr>
  <tr>
    <td class="name">PartialGuiModel$shortenPath$4</td>
  </tr>
<tr>
  <td class="name"><strong>total</strong></td>
<td class="coverageStat">
  <span class="percent">
    95%
  </span>
  <span class="absValue">
    (57/ 60)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    91.5%
  </span>
  <span class="absValue">
    (173/ 189)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<div class="sourceCode"><i>1</i>&nbsp;/*
<i>2</i>&nbsp; Copyright (c) 2014 Saarland University Software Engineering Chair. All right reserved.
<i>3</i>&nbsp;
<i>4</i>&nbsp; Author: Konrad Jamrozik, jamrozik@st.cs.uni-saarland.de
<i>5</i>&nbsp;
<i>6</i>&nbsp; This file is part of the &quot;DroidMate&quot; project.
<i>7</i>&nbsp;
<i>8</i>&nbsp; www.droidmate.org
<i>9</i>&nbsp; */
<i>10</i>&nbsp;
<i>11</i>&nbsp;package org.droidmate.exploration.abstractgui
<i>12</i>&nbsp;
<i>13</i>&nbsp;import groovy.transform.TypeChecked
<i>14</i>&nbsp;import org.droidmate.exceptions.UnexpectedAbstractGuiModelException
<i>15</i>&nbsp;import org.slf4j.Logger
<i>16</i>&nbsp;import org.slf4j.LoggerFactory
<i>17</i>&nbsp;
<i>18</i>&nbsp;import static groovy.transform.TypeCheckingMode.SKIP
<i>19</i>&nbsp;import static org.droidmate.exploration.abstractgui.GuiTransition.createClickBackGuiTransition
<i>20</i>&nbsp;import static org.droidmate.exploration.abstractgui.GuiTransition.createWidgetGuiTransition
<i>21</i>&nbsp;import static org.droidmate.logging.Markers.MARKER_ABSTRACT_GUI_MODEL_DIAGNOSTICS
<i>22</i>&nbsp;
<i>23</i>&nbsp;@TypeChecked
<i>24</i>&nbsp;class PartialGuiModel implements IPartialGuiModel
<i>25</i>&nbsp;{
<i>26</i>&nbsp;
<b class="fc"><i>27</i>&nbsp;  List&lt;Edge&gt; updateHistory     = []</b>
<b class="fc"><i>28</i>&nbsp;  List&lt;Edge&gt; transitionHistory = []</b>
<i>29</i>&nbsp;  GuiState   initialGuiState   = null
<i>30</i>&nbsp;
<i>31</i>&nbsp;  // This logger cannot be injected using @InjectLogger because it is used before dependency injection takes place.
<i>32</i>&nbsp;  // WISH try groovy&#39;s logger injection mechanism instead of guice&#39;s
<b class="fc"><i>33</i>&nbsp;  private static final Logger log = LoggerFactory.getLogger(PartialGuiModel.class)</b>
<i>34</i>&nbsp;
<i>35</i>&nbsp;  public static PartialGuiModel createEmptyPartialGuiModel()
<i>36</i>&nbsp;  {
<b class="fc"><i>37</i>&nbsp;    return new PartialGuiModel()</b>
<i>38</i>&nbsp;  }
<i>39</i>&nbsp;
<i>40</i>&nbsp;  public static PartialGuiModel createPartialGuiModelWithInitState(GuiState gs)
<i>41</i>&nbsp;  {
<b class="fc"><i>42</i>&nbsp;    PartialGuiModel model = createEmptyPartialGuiModel()</b>
<b class="fc"><i>43</i>&nbsp;    model.updateWithInitState(gs)</b>
<b class="fc"><i>44</i>&nbsp;    return model</b>
<i>45</i>&nbsp;  }
<i>46</i>&nbsp;
<i>47</i>&nbsp;  @TypeChecked(SKIP)
<i>48</i>&nbsp;  List&lt;GuiState&gt; getKnownGuiStates()
<i>49</i>&nbsp;  {
<b class="fc"><i>50</i>&nbsp;    if (updateHistory.empty)</b>
<b class="fc"><i>51</i>&nbsp;      return [initialGuiState]</b>
<i>52</i>&nbsp;    else
<b class="fc"><i>53</i>&nbsp;      return ([initialGuiState] + updateHistory.collect {Edge e -&gt; [e.src, e.trg]}.flatten()).unique()</b>
<i>54</i>&nbsp;  }
<i>55</i>&nbsp;
<i>56</i>&nbsp;  List&lt;Edge&gt; getEdges()
<i>57</i>&nbsp;  {
<b class="fc"><i>58</i>&nbsp;    return updateHistory</b>
<i>59</i>&nbsp;  }
<i>60</i>&nbsp;
<i>61</i>&nbsp;
<i>62</i>&nbsp;  GuiState getActiveGuiState()
<i>63</i>&nbsp;  {
<b class="fc"><i>64</i>&nbsp;    if (transitionHistory.empty)</b>
<b class="fc"><i>65</i>&nbsp;      return initialGuiState</b>
<i>66</i>&nbsp;    else
<b class="fc"><i>67</i>&nbsp;      return transitionHistory.last().trg</b>
<i>68</i>&nbsp;  }
<i>69</i>&nbsp;
<i>70</i>&nbsp;
<i>71</i>&nbsp;  List&lt;GuiTransition&gt; getPathTo(Widget destinationWidget)
<i>72</i>&nbsp;  {
<b class="fc"><i>73</i>&nbsp;    assert destinationWidget != null</b>
<b class="fc"><i>74</i>&nbsp;    assert destinationWidget in this.knownGuiStates*.widgets.flatten()</b>
<i>75</i>&nbsp;
<b class="fc"><i>76</i>&nbsp;    if (destinationWidget in this.widgets)</b>
<b class="fc"><i>77</i>&nbsp;      return [createWidgetGuiTransition(destinationWidget)]</b>
<i>78</i>&nbsp;
<b class="fc"><i>79</i>&nbsp;    GuiState destinationGuiState = this.knownGuiStates.find {GuiState gs -&gt; destinationWidget in gs.widgets}</b>
<b class="fc"><i>80</i>&nbsp;    assert destinationGuiState != null</b>
<i>81</i>&nbsp;
<i>82</i>&nbsp;
<b class="fc"><i>83</i>&nbsp;    List&lt;Edge&gt; trHistorySuffix = getTransitionHistorySuffixFromLastOccurrenceOfSrcGuiState(destinationGuiState)</b>
<b class="fc"><i>84</i>&nbsp;    assert trHistorySuffix.first().src == destinationGuiState</b>
<b class="fc"><i>85</i>&nbsp;    assert trHistorySuffix.last().trg == activeGuiState</b>
<i>86</i>&nbsp;
<b class="fc"><i>87</i>&nbsp;    List&lt;Edge&gt; patchedTrHistorySuffix = replaceEdgesIncidentToAppHasStoppedGuiState(trHistorySuffix)</b>
<i>88</i>&nbsp;
<b class="fc"><i>89</i>&nbsp;    trHistorySuffix = shortenPath(patchedTrHistorySuffix)</b>
<i>90</i>&nbsp;
<b class="fc"><i>91</i>&nbsp;    List&lt;Edge&gt; pathEdges = trHistorySuffix.collect {Edge pE -&gt; reverseEdge(pE)}.reverse()</b>
<b class="fc"><i>92</i>&nbsp;    assert pathEdges.first().src == activeGuiState</b>
<b class="fc"><i>93</i>&nbsp;    assert pathEdges.last().trg == destinationGuiState</b>
<i>94</i>&nbsp;
<b class="fc"><i>95</i>&nbsp;    List&lt;GuiTransition&gt; pathGuiTransitions = pathEdges.collect {Edge e -&gt; e.t}</b>
<b class="fc"><i>96</i>&nbsp;    pathGuiTransitions &lt;&lt; createWidgetGuiTransition(destinationWidget)</b>
<i>97</i>&nbsp;
<b class="fc"><i>98</i>&nbsp;    assert pathGuiTransitions?.size() &gt;= 1</b>
<b class="fc"><i>99</i>&nbsp;    assert pathGuiTransitions.last() == createWidgetGuiTransition(destinationWidget)</b>
<b class="fc"><i>100</i>&nbsp;    return pathGuiTransitions</b>
<i>101</i>&nbsp;
<i>102</i>&nbsp;  }
<i>103</i>&nbsp;
<i>104</i>&nbsp;  // MBStr one case of non-determinism would be caused by crash from two different activities: s1 -&gt; s2 -&gt; crash -&gt; s1 AND s3 -&gt; s2 -&gt; crash -&gt; s3 would result in prefixes (crash, ok, s1), (stopped, ok, s3).
<i>105</i>&nbsp;  @Override
<i>106</i>&nbsp;  boolean isDeterministic()
<i>107</i>&nbsp;  {
<b class="fc"><i>108</i>&nbsp;    List&lt;List&gt; allEdgesPrefixes = edges.collect {Edge e -&gt; [e.src, e.t]}</b>
<i>109</i>&nbsp;
<b class="fc"><i>110</i>&nbsp;    if (allEdgesPrefixes.collect().unique().size() &lt; allEdgesPrefixes.size())</b>
<b class="fc"><i>111</i>&nbsp;      return false</b>
<i>112</i>&nbsp;
<b class="fc"><i>113</i>&nbsp;    return true</b>
<i>114</i>&nbsp;  }
<i>115</i>&nbsp;
<i>116</i>&nbsp;  @Override
<i>117</i>&nbsp;  GuiTransition getLastGuiTransition()
<i>118</i>&nbsp;  {
<b class="fc"><i>119</i>&nbsp;    if (transitionHistory.empty)</b>
<b class="fc"><i>120</i>&nbsp;      return null</b>
<i>121</i>&nbsp;
<b class="fc"><i>122</i>&nbsp;    return transitionHistory.last().t</b>
<i>123</i>&nbsp;  }
<i>124</i>&nbsp;
<i>125</i>&nbsp;  public List&lt;Edge&gt; getTransitionHistorySuffixFromLastOccurrenceOfSrcGuiState(GuiState gs)
<i>126</i>&nbsp;  {
<b class="fc"><i>127</i>&nbsp;    assert gs != null</b>
<b class="fc"><i>128</i>&nbsp;    assert gs in transitionHistory.collect {Edge e -&gt; e.src}</b>
<i>129</i>&nbsp;
<b class="fc"><i>130</i>&nbsp;    List&lt;Edge&gt; trHistorySuffix = transitionHistory.reverse().takeWhile {Edge e -&gt; e.src != gs}.reverse()</b>
<i>131</i>&nbsp;
<b class="fc"><i>132</i>&nbsp;    Edge edgeFromGuiState = transitionHistory.reverse().dropWhile {Edge e -&gt; e.src != gs}.first()</b>
<i>133</i>&nbsp;
<b class="fc"><i>134</i>&nbsp;    trHistorySuffix = ([edgeFromGuiState] + trHistorySuffix) as List&lt;Edge&gt;</b>
<i>135</i>&nbsp;
<b class="fc"><i>136</i>&nbsp;    assert trHistorySuffix?.size() &gt;= 1</b>
<b class="fc"><i>137</i>&nbsp;    assert trHistorySuffix.first().src == gs</b>
<b class="fc"><i>138</i>&nbsp;    assert trHistorySuffix.count {Edge e -&gt; e.src == gs} == 1</b>
<b class="fc"><i>139</i>&nbsp;    return trHistorySuffix</b>
<i>140</i>&nbsp;  }
<i>141</i>&nbsp;
<i>142</i>&nbsp;  List&lt;Edge&gt; replaceEdgesIncidentToAppHasStoppedGuiState(List&lt;Edge&gt; trHistorySuffix)
<i>143</i>&nbsp;  {
<b class="fc"><i>144</i>&nbsp;    assert trHistorySuffix?.size() &gt;= 1</b>
<b class="fc"><i>145</i>&nbsp;    assert !trHistorySuffix.first().src.isAppHasStoppedDialogBox()</b>
<b class="fc"><i>146</i>&nbsp;    assert !trHistorySuffix.last().trg.isAppHasStoppedDialogBox()</b>
<b class="fc"><i>147</i>&nbsp;    assertConsistent(trHistorySuffix)</b>
<i>148</i>&nbsp;
<b class="fc"><i>149</i>&nbsp;    List&lt;Edge&gt; ret = trHistorySuffix</b>
<i>150</i>&nbsp;
<b class="fc"><i>151</i>&nbsp;    while (ret.any {Edge e -&gt; e.trg.isAppHasStoppedDialogBox()})</b>
<i>152</i>&nbsp;    {
<b class="fc"><i>153</i>&nbsp;      Edge toStopped = ret.find {Edge e -&gt; e.trg.isAppHasStoppedDialogBox()}</b>
<b class="fc"><i>154</i>&nbsp;      int toStoppedIndex = ret.findIndexOf {Edge e -&gt; e == toStopped}</b>
<b class="fc"><i>155</i>&nbsp;      assert toStoppedIndex &lt; ret.size() - 1</b>
<b class="fc"><i>156</i>&nbsp;      Edge fromStopped = ret[toStoppedIndex + 1]</b>
<i>157</i>&nbsp;
<b class="fc"><i>158</i>&nbsp;      Edge replacement = Edge.createEdge(</b>
<i>159</i>&nbsp;        toStopped.src,
<b class="fc"><i>160</i>&nbsp;        createClickBackGuiTransition(),</b>
<i>161</i>&nbsp;        fromStopped.trg)
<i>162</i>&nbsp;
<b class="fc"><i>163</i>&nbsp;      if (!(edges.any {Edge e -&gt; e.src == replacement.trg &amp;&amp; e.t.isWidgetTransition() &amp;&amp; e.trg == replacement.src}))</b>
<b class="nc"><i>164</i>&nbsp;        throw new UnexpectedAbstractGuiModelException(&quot;App under test package name: ${this.appPackageName}\n&quot; +</b>
<b class="nc"><i>165</i>&nbsp;          &#39;Expected that when activity_2 crashed the app (showing &quot;app has stopped&quot; dialog box) and that when closing the &quot;app has stopped&quot; dialog box resulted in activity_1 being in scope, then there should have been transition through widget from activity_1 to activity_2 model. This turns out to be untrue, but DroidMate cannot handle situation when such widget is missing, because it doesn\&#39;t know how to reach activity_2 without it.\n&#39; +</b>
<i>166</i>&nbsp;          &quot;The activity_1 GUI state (it should have a widget transiting to activity_2 GUI state: ${replacement.trg}\n&quot; +
<i>167</i>&nbsp;          &quot;The activity_2 GUI state: ${replacement.src}&quot;)
<i>168</i>&nbsp;
<b class="fc"><i>169</i>&nbsp;      ret = ret.plus(toStoppedIndex, [replacement])</b>
<b class="fc"><i>170</i>&nbsp;      ret.remove(toStopped)</b>
<b class="fc"><i>171</i>&nbsp;      ret.remove(fromStopped)</b>
<b class="fc"><i>172</i>&nbsp;      assert ret[toStoppedIndex] == replacement</b>
<i>173</i>&nbsp;
<i>174</i>&nbsp;    }
<i>175</i>&nbsp;
<b class="fc"><i>176</i>&nbsp;    assert ret != null</b>
<b class="fc"><i>177</i>&nbsp;    assert ret.size() &lt;= trHistorySuffix.size()</b>
<b class="fc"><i>178</i>&nbsp;    assert ret.first().src == trHistorySuffix.first().src</b>
<b class="fc"><i>179</i>&nbsp;    assert ret.last().trg == trHistorySuffix.last().trg</b>
<b class="fc"><i>180</i>&nbsp;    assertConsistent(ret)</b>
<b class="fc"><i>181</i>&nbsp;    assert ret.each {Edge e -&gt; e in trHistorySuffix}</b>
<b class="fc"><i>182</i>&nbsp;    assert getPathGuiStates(ret).every {GuiState gs -&gt; !gs.isAppHasStoppedDialogBox()}</b>
<b class="fc"><i>183</i>&nbsp;    return ret</b>
<i>184</i>&nbsp;  }
<i>185</i>&nbsp;
<i>186</i>&nbsp;  public Edge reverseEdge(Edge pE)
<i>187</i>&nbsp;  {
<b class="fc"><i>188</i>&nbsp;    Edge reversedEdge = edges.find {Edge exE -&gt; exE.src == pE.trg &amp;&amp; exE.trg == pE.src}</b>
<i>189</i>&nbsp;
<b class="fc"><i>190</i>&nbsp;    Edge retEdge</b>
<i>191</i>&nbsp;
<b class="fc"><i>192</i>&nbsp;    if (reversedEdge == null)</b>
<b class="fc"><i>193</i>&nbsp;      retEdge = new Edge(</b>
<i>194</i>&nbsp;        src: pE.trg,
<b class="fc"><i>195</i>&nbsp;        t: createClickBackGuiTransition(),</b>
<i>196</i>&nbsp;        trg: pE.src)
<i>197</i>&nbsp;    else
<b class="fc"><i>198</i>&nbsp;      retEdge = reversedEdge</b>
<i>199</i>&nbsp;
<b class="fc"><i>200</i>&nbsp;    assert retEdge != null</b>
<b class="fc"><i>201</i>&nbsp;    return retEdge</b>
<i>202</i>&nbsp;  }
<i>203</i>&nbsp;
<i>204</i>&nbsp;  List&lt;Edge&gt; shortenPath(List&lt;Edge&gt; path)
<i>205</i>&nbsp;  {
<b class="fc"><i>206</i>&nbsp;    assert path?.size() &gt;= 1</b>
<b class="fc"><i>207</i>&nbsp;    assert path.last().trg == this.activeGuiState</b>
<b class="fc"><i>208</i>&nbsp;    assert path.first().src != path.last().trg</b>
<b class="fc"><i>209</i>&nbsp;    assert getPathGuiStates(path).count(getPathGuiStates(path).first()) == 1</b>
<b class="fc"><i>210</i>&nbsp;    assertConsistent(path)</b>
<i>211</i>&nbsp;
<b class="fc"><i>212</i>&nbsp;    List&lt;Edge&gt; retPath = path</b>
<i>213</i>&nbsp;
<b class="fc"><i>214</i>&nbsp;    retPath = retPath.findAll {Edge e -&gt; e.src != e.trg} as List&lt;Edge&gt;</b>
<i>215</i>&nbsp;
<i>216</i>&nbsp;
<b class="fc"><i>217</i>&nbsp;    while (getPathGuiStates(retPath).any {GuiState gs -&gt; getPathGuiStates(retPath).count(gs) &gt; 1})</b>
<i>218</i>&nbsp;    {
<b class="fc"><i>219</i>&nbsp;      List&lt;Edge&gt; updatedRetEdges</b>
<b class="fc"><i>220</i>&nbsp;      GuiState redundantGuiState = getPathGuiStates(retPath).find {GuiState gs -&gt; getPathGuiStates(retPath).count(gs) &gt; 1}</b>
<b class="fc"><i>221</i>&nbsp;      updatedRetEdges = retPath.takeWhile {Edge e -&gt; e.src != redundantGuiState}</b>
<b class="fc"><i>222</i>&nbsp;      updatedRetEdges += retPath.reverse().takeWhile {Edge e -&gt; e.trg != redundantGuiState}.reverse()</b>
<i>223</i>&nbsp;
<b class="fc"><i>224</i>&nbsp;      assert updatedRetEdges.size() &lt;= retPath.size() - 2</b>
<b class="fc"><i>225</i>&nbsp;      assert getPathGuiStates(updatedRetEdges).count(redundantGuiState) == 1</b>
<i>226</i>&nbsp;
<b class="fc"><i>227</i>&nbsp;      retPath = updatedRetEdges</b>
<i>228</i>&nbsp;    }
<i>229</i>&nbsp;
<b class="fc"><i>230</i>&nbsp;    assert retPath != null</b>
<b class="fc"><i>231</i>&nbsp;    assert retPath.size() &lt;= path.size()</b>
<b class="fc"><i>232</i>&nbsp;    assert retPath.first().src == path.first().src</b>
<b class="fc"><i>233</i>&nbsp;    assert retPath.last().trg == path.last().trg</b>
<b class="fc"><i>234</i>&nbsp;    assertConsistent(retPath)</b>
<b class="fc"><i>235</i>&nbsp;    assert retPath.each {Edge e -&gt; e in path}</b>
<b class="fc"><i>236</i>&nbsp;    assert getPathGuiStates(retPath).every {getPathGuiStates(retPath).count(it) == 1}</b>
<b class="fc"><i>237</i>&nbsp;    return retPath</b>
<i>238</i>&nbsp;  }
<i>239</i>&nbsp;
<i>240</i>&nbsp;  public static List&lt;GuiState&gt; getPathGuiStates(List&lt;Edge&gt; edges)
<i>241</i>&nbsp;  {
<b class="fc"><i>242</i>&nbsp;    assert edges?.size() &gt;= 1</b>
<b class="fc"><i>243</i>&nbsp;    assertConsistent(edges)</b>
<b class="fc"><i>244</i>&nbsp;    return (edges.collect {Edge e -&gt; e.src} + edges.last().trg) as List&lt;GuiState&gt;</b>
<i>245</i>&nbsp;  }
<i>246</i>&nbsp;
<i>247</i>&nbsp;  public static void assertConsistent(List&lt;Edge&gt; edges)
<i>248</i>&nbsp;  {
<b class="fc"><i>249</i>&nbsp;    edges[0..&lt;edges.size() - 1].eachWithIndex {Edge e, int i -&gt;</b>
<b class="fc"><i>250</i>&nbsp;      assert e.trg == edges[i + 1].src</b>
<i>251</i>&nbsp;    }
<i>252</i>&nbsp;  }
<i>253</i>&nbsp;
<i>254</i>&nbsp;  @Override
<i>255</i>&nbsp;  void updateWithInitState(GuiState guiState)
<i>256</i>&nbsp;  {
<b class="fc"><i>257</i>&nbsp;    log.debug(&quot;Updating with initial ${GuiState.simpleName}: $guiState\n&quot;)</b>
<i>258</i>&nbsp;
<b class="fc"><i>259</i>&nbsp;    assert initialGuiState == null</b>
<b class="fc"><i>260</i>&nbsp;    assert updateHistory.empty</b>
<b class="fc"><i>261</i>&nbsp;    assert transitionHistory.empty</b>
<i>262</i>&nbsp;
<i>263</i>&nbsp;    // MBStr to uncomment and fix failing tests
<i>264</i>&nbsp;//    assert !(guiState.isHomeScreen() || guiState.isAppHasStoppedDialogBox()):
<i>265</i>&nbsp;//      &quot;The initial GUI state of the model has to belong to the application under exploration.&quot;
<i>266</i>&nbsp;
<b class="fc"><i>267</i>&nbsp;    initialGuiState = guiState</b>
<i>268</i>&nbsp;
<i>269</i>&nbsp;  }
<i>270</i>&nbsp;
<i>271</i>&nbsp;
<i>272</i>&nbsp;  void update(Edge edge)
<i>273</i>&nbsp;  {
<b class="fc"><i>274</i>&nbsp;    log.debug(&quot;Updating with ${Edge.simpleName}: $edge\n&quot;)</b>
<i>275</i>&nbsp;
<b class="fc"><i>276</i>&nbsp;    assert edge != null</b>
<i>277</i>&nbsp;
<b class="fc"><i>278</i>&nbsp;    if (!(edge in edges))</b>
<i>279</i>&nbsp;    {
<b class="fc"><i>280</i>&nbsp;      assert (edge.src in knownGuiStates)</b>
<b class="fc"><i>281</i>&nbsp;      updateHistory &lt;&lt; edge</b>
<i>282</i>&nbsp;    } else
<i>283</i>&nbsp;    {
<b class="fc"><i>284</i>&nbsp;      assert edge.src in knownGuiStates</b>
<b class="fc"><i>285</i>&nbsp;      assert edge.trg in knownGuiStates</b>
<i>286</i>&nbsp;    }
<i>287</i>&nbsp;  }
<i>288</i>&nbsp;
<i>289</i>&nbsp;
<i>290</i>&nbsp;  void transit(Widget w)
<i>291</i>&nbsp;  {
<b class="fc"><i>292</i>&nbsp;    transit(createWidgetGuiTransition(w))</b>
<i>293</i>&nbsp;  }
<i>294</i>&nbsp;
<i>295</i>&nbsp;  void transit(GuiTransition guiTransition)
<i>296</i>&nbsp;  {
<b class="fc"><i>297</i>&nbsp;    log.debug(&quot;Transiting with ${GuiTransition.simpleName}: $guiTransition\n&quot;)</b>
<i>298</i>&nbsp;
<b class="fc"><i>299</i>&nbsp;    assert guiTransition != null</b>
<i>300</i>&nbsp;
<b class="fc"><i>301</i>&nbsp;    if (guiTransition.isWidgetTransition())</b>
<b class="fc"><i>302</i>&nbsp;      assert guiTransition.transitionWidget in activeGuiState.widgets : &quot;The transition widget of current GUI transition is not present on the currently active GUI state. This could be caused by wrong active GUI state, and wrong GUI state could happen if a transition on non-deterministic model has been allowed. In other words, if this assertion fails, the model is probably non-deterministic and thus, shouldn&#39;t allow for transitions.&quot;</b>
<i>303</i>&nbsp;
<b class="fc"><i>304</i>&nbsp;    int edgesPrefixesCount = edges.count {Edge edge -&gt; isFromActiveStateByTransition(edge, guiTransition)} as int</b>
<b class="fc"><i>305</i>&nbsp;    assert edgesPrefixesCount &gt;= 1:</b>
<b class="nc"><i>306</i>&nbsp;      &quot;Failed to find GUI model graph edge prefix of form (Active GUI state, GUI transition, _).\n&quot; +</b>
<b class="nc"><i>307</i>&nbsp;        &quot;Possible cause: called transit() before creating required edge with update().\n&quot; +</b>
<b class="nc"><i>308</i>&nbsp;        &quot;Active GUI state: $activeGuiState.\n&quot; +</b>
<b class="nc"><i>309</i>&nbsp;        &quot;GUI transition: $guiTransition\n&quot; +</b>
<i>310</i>&nbsp;        &quot;Edges: $edges&quot;
<b class="fc"><i>311</i>&nbsp;    if (edgesPrefixesCount &gt; 1)</b>
<b class="nc"><i>312</i>&nbsp;      log.warn(MARKER_ABSTRACT_GUI_MODEL_DIAGNOSTICS, &quot;Non-deterministic model detected. Currently active GUI state, &quot; +</b>
<b class="nc"><i>313</i>&nbsp;        &quot;when followed with transited transition, can end up in ${edgesPrefixesCount} states.\n&quot; +</b>
<b class="nc"><i>314</i>&nbsp;        &quot;More precise reason for non-determinism: found more than one edge prefix of form &quot; +</b>
<b class="nc"><i>315</i>&nbsp;        &quot;(Active GUI state, GUI transition, _)\n&quot; +</b>
<i>316</i>&nbsp;        &quot;Active GUI state: $activeGuiState.\n&quot; +
<i>317</i>&nbsp;        &quot;The transited GUI transition: $guiTransition.\n&quot;)
<i>318</i>&nbsp;
<b class="fc"><i>319</i>&nbsp;    Edge edge = edges.find {Edge edge -&gt; isFromActiveStateByTransition(edge, guiTransition)}</b>
<i>320</i>&nbsp;
<b class="fc"><i>321</i>&nbsp;    assert transitionHistory.empty || edge.src == transitionHistory.last().trg</b>
<i>322</i>&nbsp;
<b class="fc"><i>323</i>&nbsp;    transitionHistory &lt;&lt; edge</b>
<i>324</i>&nbsp;
<b class="fc"><i>325</i>&nbsp;    assertConsistent(transitionHistory)</b>
<b class="fc"><i>326</i>&nbsp;    assert activeGuiState == edge.trg</b>
<i>327</i>&nbsp;
<i>328</i>&nbsp;  }
<i>329</i>&nbsp;
<i>330</i>&nbsp;  List&lt;GuiState&gt; getGuiStatesByTransitionHistoryMostRecentFirst()
<i>331</i>&nbsp;  {
<b class="fc"><i>332</i>&nbsp;    List&lt;GuiState&gt; ret = transitionHistory.collect {Edge e -&gt; e.src}.reverse() as List&lt;GuiState&gt;</b>
<i>333</i>&nbsp;
<b class="fc"><i>334</i>&nbsp;    assert ret.empty || ret.last() == initialGuiState</b>
<b class="fc"><i>335</i>&nbsp;    return ret</b>
<i>336</i>&nbsp;  }
<i>337</i>&nbsp;
<i>338</i>&nbsp;  @Override
<i>339</i>&nbsp;  boolean isEmpty()
<i>340</i>&nbsp;  {
<b class="fc"><i>341</i>&nbsp;    return initialGuiState == null</b>
<i>342</i>&nbsp;  }
<i>343</i>&nbsp;
<i>344</i>&nbsp;  private boolean isFromActiveStateByTransition(Edge edge, GuiTransition transition)
<i>345</i>&nbsp;  {
<b class="fc"><i>346</i>&nbsp;    return edge.src == activeGuiState &amp;&amp; edge.t == transition</b>
<i>347</i>&nbsp;  }
<i>348</i>&nbsp;
<i>349</i>&nbsp;  public String getActivePackageName()
<i>350</i>&nbsp;  {
<b class="nc"><i>351</i>&nbsp;    return activeGuiState.topNodePackageName</b>
<i>352</i>&nbsp;  }
<i>353</i>&nbsp;
<i>354</i>&nbsp;  public List&lt;Widget&gt; getWidgets()
<i>355</i>&nbsp;  {
<b class="fc"><i>356</i>&nbsp;    return activeGuiState.widgets</b>
<i>357</i>&nbsp;  }
<i>358</i>&nbsp;
<i>359</i>&nbsp;
<i>360</i>&nbsp;  @Override
<i>361</i>&nbsp;  String getAppPackageName()
<i>362</i>&nbsp;  {
<b class="fc"><i>363</i>&nbsp;    return initialGuiState.topNodePackageName</b>
<i>364</i>&nbsp;  }
<i>365</i>&nbsp;
<i>366</i>&nbsp;  @Override
<i>367</i>&nbsp;  boolean isHomeScreen()
<i>368</i>&nbsp;  {
<b class="fc"><i>369</i>&nbsp;    return this.activeGuiState.isHomeScreen()</b>
<i>370</i>&nbsp;  }
<i>371</i>&nbsp;
<i>372</i>&nbsp;  @Override
<i>373</i>&nbsp;  boolean isAppHasStoppedDialogBox()
<i>374</i>&nbsp;  {
<b class="fc"><i>375</i>&nbsp;    return this.activeGuiState.isAppHasStoppedDialogBox()</b>
<i>376</i>&nbsp;  }
<i>377</i>&nbsp;
<i>378</i>&nbsp;  @Override
<i>379</i>&nbsp;  boolean isOutOfAppScope()
<i>380</i>&nbsp;  {
<b class="fc"><i>381</i>&nbsp;    return this.activeGuiState.isOutOfScope(this.appPackageName)</b>
<i>382</i>&nbsp;  }
<i>383</i>&nbsp;
<i>384</i>&nbsp;  @Override
<i>385</i>&nbsp;  boolean isSpecialCase()
<i>386</i>&nbsp;  {
<b class="fc"><i>387</i>&nbsp;    return this.activeGuiState.isSpecialCase(this.appPackageName)</b>
<i>388</i>&nbsp;  }
<i>389</i>&nbsp;
<i>390</i>&nbsp;
<i>391</i>&nbsp;  @Override
<i>392</i>&nbsp;  public String toString()
<i>393</i>&nbsp;  {
<b class="nc"><i>394</i>&nbsp;    return &quot;PartialGuiModel:\n&quot; +</b>
<b class="nc"><i>395</i>&nbsp;      &quot;initialGuiState=$initialGuiState\n&quot; +</b>
<i>396</i>&nbsp;      //&quot;updateHistory=$updateHistory\n&quot; +
<i>397</i>&nbsp;      //&quot;transitionHistory=$transitionHistory\n&quot;+
<b class="nc"><i>398</i>&nbsp;      &quot;guiStates count: ${knownGuiStates.size()}\n&quot; +</b>
<b class="nc"><i>399</i>&nbsp;      &quot;guiStates widgets count: ${knownGuiStates.collect {GuiState gs -&gt; gs.widgets.size()}}\n&quot; // +</b>
<i>400</i>&nbsp;    //&quot;guiStates: $guiStates\n&quot; +
<i>401</i>&nbsp;    //&quot;guiStates&#39; widgets: ${guiStates.collect { GuiState gs -&gt; gs.widgets}}\n&quot;
<i>402</i>&nbsp;
<i>403</i>&nbsp;  }
<i>404</i>&nbsp;}
</div>
</div>

<div class="footer">
    
    <div style="float:right;">generated on 2014-04-01 16:05</div>
</div>
</body>
</html>
